---
title: "State"
description: "How to use state in workflows"
---

# State in Workflows

LlamaIndex workflows, beyond being event-driven, can also be stateful.

More specifically, the state can be defined as an _internal representation_ of the current workflow execution.

The workflow state is _typed_, meaning that it can be defined as a `type` and can be accessed and modified following that type's property.

Here is an example:

```ts
type AgentWorkflowState = {
  user_message: string,
  retrieved_information: string[],
  num_iterations: number,
};
```

You can then add a state to your workflow in this way:

```ts
import { createStatefulMiddleware } from "@llamaindex/workflow-core/middleware/state";

const { withState } = createStatefulMiddleware(
  (state: AgentWorkflowState) => state,
);
const workflow = withState(createWorkflow());
```

And then, in your step handling logic, you can access and modify state properties:

```ts 
workflow.handle([userInputEvent], async (context, { data }) => {
  const { sendEvent, state } = context;
  const { userInput } = data;

  state.user_message = userInput;

  retrievedInfo = await retriever.retrieve({query: userInput, top_k: 5})

  if (retrievedInfo && retrievedInfo.length > 0) {
    state.retrieved_information.push(...retrievedInfo)
    response = await llm.complete(`Please reply to this message: ${userInput} based on this information: ${retrievedInfo.join('\n\n---\n\n')}.`)
    sendEvent(finalResponseEvent.with({result: response}))
  } else {
    if (state.num_iterations < 5) {
        state.num_iterations += 1
        newQuery = await llm.complete(`Please rewrite this message: ${userInput} so that it can retrieve more relevant contextual information.`)
        sendEvent(userInputEvent.with({userInput: newQuery}))
    } else {
        sendEvent(finalResponseEvent.with({result: "Unable to find a response to your query based on the information in our database"}));
    }
  }
});
```

Before running the workflow, remember to initialize the context object with the state:

```typescript
const { stream, sendEvent } = workflow.createContext({
  user_message: "What is the number I need to call for customer support?",
  retrieved_information: [],
  num_iterations: 0,
});
```